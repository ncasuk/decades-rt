!! TEXTOUT.FOR - Handles CGI requests for HORACE functions that do not require! graph plotting.!! The function required is passed in the global symbol "QUERY_STRING"!! All output goes to SYS$OUTPUT and thus to the client!! Note that the push method is used for updating, wherebye a new message is! sent automatically when new data is available.!      PROGRAM TEXTOUT      IMPLICIT NONE      INTEGER*4 IOS      CHARACTER CFUNCT*40      OPEN(6,FILE='SYS$OUTPUT',STATUS='NEW',CARRIAGECONTROL='LIST')      WRITE(6,'(A)',IOSTAT=IOS)      -'content-type: multipart/x-mixed-replace;boundary=next_part'      WRITE(6,'(A)',IOSTAT=IOS)       CALL LIB$GET_SYMBOL('QUERY_STRING',CFUNCT)      IF(CFUNCT.EQ.'hor_dump') THEN        CALL WEB_HOR_DUMP      END IF      CALL EXIT      ENDC*******************************************************************************      INTEGER*4 FUNCTION LAN(CSTRING)      IMPLICIT NONE      INTEGER*4 N      CHARACTER*(*) CSTRING      N=LEN(CSTRING)                   !Get string length      DO WHILE(N.GT.0.AND.CSTRING(N:N).EQ.' ') !Step back over spaces        N=N-1      END DO      IF(N.EQ.0) N=1                   !Special case      LAN=N      RETURN      ENDC*******************************************************************************      SUBROUTINE WEB_HOR_DUMPCC Displays derived parameters values for most parameters in tabular form.  ThisC implements the function of Option 4 of the main HORACE menu.  The display isC updated every 3 seconds, when a new set of derived data becomes available.CC External data:CC DERIVE  R*4  Passed   HOR_CALCS    2560 secs of 150 derived parametersC                                    contained in a circular bufferCC Subroutines called:C     C     WEB_DUMP_DISPLAYC      IMPLICIT  NONE      INTEGER*4 IS,RZ,IWA,IWS,IOS      LOGICAL*4 LPRTFLG      CHARACTER CLINE(6)*56,CTOP*56      REAL*4    RGALTI,RGLONG,RGLATI,RSURF      INCLUDE   'HORACE:HCOM_DEF.FOR'      CHARACTER CHEAD(12)*56 /     -' IHDG    SPR   PHGT   DTAT   DEW     LCL   TAS    WIND  ',     -'  deg    mb     ft      C      C      m     m/s  deg m/s',     -' OZMR    VP    RHGT   NTAT  TWCDP    TWC   GLAT   GLONG ',     -'  ppb    mb     ft      C      C    gkg-1   deg    deg  ',     -'  Th    Th e   GHGT   ICTP   FLDP    LWC   ILAT   ILONG ',     -'   K      K     ft      C      C    gkg-1   deg    deg  ',     -'  HMR   FHMR    MMR    ST    SHUM    MAD    DAD   SZEN  ',     -' gm-3   gm-3   gkg-1    C    gkg-1  kgm-3  kgm-3   deg  ',     -' UCLR   URED    UIR   PTCH   ROLL     U      V      W   ',     -' Wm-2   Wm-2   Wm-2    deg    deg    ms-1   ms-1   ms-1 ',     -' LCLR   LRED    LIR    IGS    IDA    VN     VE     VZ   ',      -' Wm-2   Wm-2   Wm-2    ms-1   deg    ms-1   ms-1   ms-1 '/C      IS=STATUS(2)-1100   IS=IS+1      IF(IS.GT.2560) IS=IS-2560      IF(IS.LT.1.OR.IS.GT.2560) RETURN      IF(STATUS(34)) THEN              !If latest derivations are valid        WRITE(CTOP,10,IOSTAT=IOS) CFNUM,CFDAT,JHRS(IS),JMIN(IS),     -      JSEC(IS),JEVM(IS),RGLAT(IS),RGLNG(IS)      ELSE        WRITE(CTOP,10,IOSTAT=IOS) CFNUM,CFDAT,0,0,0,0,0.,0.      END IF      LPRTFLG=.TRUE.      IF(STATUS(35)) THEN              !If GPS data is valid        RGLATI=RGLAT(IS)               !Use it        RGLONG=RGLNG(IS)        RGALTI=RGALT(IS)      ELSE                             !Else use zeros        RGLATI=0.0        RGLONG=0.0        RGALTI=0.0      END IF      IF(RST(IS).EQ.99.9) THEN         !If Barnes data invalid        RSURF=RPRT4(IS)        LPRTFLG=.TRUE.      ELSE         RSURF=RST(IS)        LPRTFLG=.FALSE.      END IFCC Generate the formatted values into lines using internal write statements.C      IF(STATUS(34)) THEN              !If latest derivations are valid        IWA=NINT(RIWA(IS))             !convert winds to integer        IWS=NINT(RIWS(IS))        WRITE(CLINE(1),11,IOSTAT=IOS) RIHDG(IS),RSPR(IS),RPHGTF(IS)*     -      1000.0,RTATDC(IS),RDEW(IS),RLCLVL(IS),RTAS(IS)*0.502,IWA,IWS        WRITE(CLINE(2),12,IOSTAT=IOS) ROZMR(IS),RVP(IS),RRHGT(IS)*3.28,     -      RTATNC(IS),RTWCDP(IS),RTWC(IS),RGLATI,RGLONG         WRITE(CLINE(3),13,IOSTAT=IOS) RPOT(IS),RPOTE(IS),RGALTI*3.28,     -      RICT(IS),RFLDP(IS),RLWC(IS)/RDAD(IS),RILAT(IS),RILNG(IS)        WRITE(CLINE(4),14,IOSTAT=IOS) RHMR(IS),RFHMR(IS),RMMR(IS),RSURF,     -      RSHUM(IS),RMAD(IS),RDAD(IS),RSZEN(IS)        WRITE(CLINE(5),15,IOSTAT=IOS) RUCLR(IS),RURED(IS),RUIR(IS),     -      RPTCH(IS),RROLL(IS),RU(IS),RV(IS),RW(IS)        WRITE(CLINE(6),16,IOSTAT=IOS) RLCLR(IS),RLRED(IS),RLIR(IS),     -      RIGS(IS),RIDA(IS),RVN(IS),RVE(IS),RVZ(IS)      ELSE                             !If derivations invalid show zeros        WRITE(CLINE(1),20,IOSTAT=IOS) RZ,RZ,RZ,RZ,RZ,RZ,RZ,RZ,RZ        WRITE(CLINE(2),21,IOSTAT=IOS) RZ,RZ,RZ,RZ,RZ,RZ,RGLATI,RGLONG        WRITE(CLINE(3),22,IOSTAT=IOS) RZ,RZ,RGALTI,RZ,RZ,RZ,RZ,RZ        WRITE(CLINE(4),21,IOSTAT=IOS) RZ,RZ,RZ,RZ,RZ,RZ,RZ,RZ        WRITE(CLINE(5),21,IOSTAT=IOS) RZ,RZ,RZ,RZ,RZ,RZ,RZ,RZ        WRITE(CLINE(6),21,IOSTAT=IOS) RZ,RZ,RZ,RZ,RZ,RZ,RZ,RZ      END IFCC Put in the special condition flags for the Barnes, Cambridge and WaterC Vapour sensor in red.C!      CALL SEL(0,IRED,-1)              !red additive!      CALL SCA(13,13,0,2)              !small letters!      IF(IDP(IS).EQ.1) CALL ALP(17+4*92,56,'C') !hygrometer control condition!      IF(IDP(IS).NE.1) CALL ALP(17+4*92,56,' ')!      IF(IPRT4(IS).EQ.1.AND.LPRTFLG) THEN!        CALL ALP(17+3*92,56+72*3,'C') !Barnes on calibrate!      ELSE IF(IPRT4(IS).EQ.2.AND.LPRTFLG) THEN!        CALL ALP(17+3*92,56+72*3,'T') !Barnes temperature!      ELSE!!        CALL ALP(17+3*92,56+72*3,' ')!      END IF!      IF(.NOT.LPRTFLG) CALL ALP(17+3*92,56+72*2,'ST') !Corrected surface temperaturE!      IF(LPRTFLG) CALL ALP(17+3*92,56+72*2,'  ') !Corrected surface temperaturE!      IF(IFLDP(IS).EQ.1) CALL ALP(17+4*92,56+72*2,'C') !fluor wvs on calibrate!      IF(IFLDP(IS).NE.1) CALL ALP(17+4*92,56+72*2,' ')!      IF(SPECIAL(IS,8).GE.1) THEN      !If GPS data wrong!!        CALL ALP(17+6*92,56+72*1,'W')!        CALL ALP(17+7*92,56+72*1,'W')!        CALL ALP(17+2*92,56+72*2,'W')!      ELSE!        CALL ALP(17+6*92,56+72*1,' ')!        CALL ALP(17+7*92,56+72*1,' ')!        CALL ALP(17+2*92,56+72*2,' ')!      END IF C      CALL WEB_DUMP_DISPLAY(CTOP,CHEAD,CLINE)C      DO WHILE(.TRUE.)        IF(STATUS(2).NE.IS) GOTO 100        CALL LIB$WAIT(0.2)      END DOC10    FORMAT(X,A4,2X,A9,2X,2(I2.2,':'),I2.2,2X,I3.3,2X,F6.2,2X,F7.2,2X,     -    A)11    FORMAT(2X,F5.0,2(1X,F6.0),2(2X,F5.1),1X,F6.0,1X,F6.1,I4.3,'/',     -    I2)12    FORMAT(2(1X,F6.1),1X,F6.0,2(2X,F5.1),2(1X,F6.2),F7.2)13    FORMAT(2(1X,F6.1),1X,F6.0,2(2X,F5.1),2(1X,F6.2),F7.2)14    FORMAT(5(1X,F6.1),2(1X,F6.2),1X,F6.1)15    FORMAT(3(1X,F6.0),2(2X,F5.1),3(1X,F6.0))16    FORMAT(8(1X,F6.0)) 20    FORMAT(7(1X,F6.2),F3.0,'/',F3.0)21    FORMAT(8(1X,F6.2))22    FORMAT(2(1X,F6.2),1X,F6.0,4(1X,F6.2))      ENDC*******************************************************************************      SUBROUTINE WEB_DUMP_DISPLAY(CTOP,CHEAD,CLINE)      IMPLICIT NONE      INTEGER*4 I,J,II,JJ,LAN      CHARACTER CTOP*56,CHEAD(12)*56,CLINE(6)*56,C1*8,C2*8,C3*8      WRITE(6,'(A)') '--next_part'      WRITE(6,'(A)') 'content-type: text/html'      WRITE(6,'(A)')       WRITE(6,'(A)') '<HTML><HEAD><TITLE>HOR_DUMP</TITLE></HEAD>'!      WRITE(6,'(A)') '<LAYER NAME="id1" VISIBILITY=hide>'!      WRITE(6,'(A)') '<BODY>'!      WRITE(6,'(A)') !     &   '<BODY onload="document.layers[''id1''].visibility=''show'';">'      WRITE(6,'(A)') '<TABLE BORDER COLS=1 WIDTH="100%">'      WRITE(6,'(A)') '<TR><TD><CENTER>'//CTOP(1:LAN(CTOP))//'</CENTER>'      WRITE(6,'(A)') '</TD></TR></TABLE>'      DO I=1,6        WRITE(6,'(A)') '<TABLE BORDER COLS=8 WIDTH="100%">'        WRITE(6,'(A)') '<TR>'        II=(I-1)*2+1        DO J=1,8          JJ=(J-1)*7+1          C1=CHEAD(II)(JJ:JJ+6)          C2=CHEAD(II+1)(JJ:JJ+6)          C3=CLINE(I)(JJ:JJ+6)          WRITE(6,'(A)') '<TD><CENTER>'//C1//'<BR><FONT SIZE =-1>'//     &        C2//'</FONT><BR>'//C3//'</CENTER></TD>'        END DO        WRITE(6,'(A)') '</TR>'        WRITE(6,'(A)') '</TABLE>'      END DO                      WRITE(6,'(A)') '</BODY>'!      WRITE(6,'(A)') '</LAYER>'!      WRITE(6,'(A)') '<SCRIPT>'!      WRITE(6,'(A)') 'document.layers["id1"].visibility="show";'!      WRITE(6,'(A)') 'document.layers["id1"].moveTo(100,25);'!      WRITE(6,'(A)') '</SCRIPT>'      WRITE(6,'(A)') '</HTML>'      RETURN      END